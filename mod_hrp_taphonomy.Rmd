---
title: "HRP Taphonomy"
author: "Jyhreh Johnson"
date: "2023-10-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE) # Toggle whether to show R code chunks
```


```{r echo = FALSE, include=FALSE}
# Preliminaries, Load necessary libraries
library(ggplot2)
library(tidyverse)
library(dplyr)
library(jsonlite)
library(ggstatsplot)
library(knitr)
library(stringr)
```

# Materials and Methods
```{r load_hadar_data}
# Load/Reload Data from Origins using the API
HADAR_URL <- "https://paleocore.org/origins/api/hadarfossilelements/"
hadar_df <- as.data.frame(fromJSON(HADAR_URL)) # loads in the Hadar fossil elements from paleocore. Make sure to save changes in paleocore before running. 
# Load Skeletal Element API
SKELETAL_ELEMENTS_URL<-"https://paleocore.org/origins/api/skeletalelements/"
hadar_api <- as.data.frame(fromJSON(SKELETAL_ELEMENTS_URL)) #loads in the skeletal elements from Paleo Core API.
```

Data used for this project were downloaded from the Origins project website API using the following URL's:  
1. The published hadar fossil data are available at: `r HADAR_URL`  
2. A dataset of all skeletal elements from Uberon is also available from Origins at: `r SKELETAL_ELEMENTS_URL`. 

## Data Summary
```{r}
hadar_merge <- merge(hadar_df, hadar_api,by.x = "uberon_id", by.y = "uberon_id", all.x = FALSE, all.y = FALSE) # merge the hadar df and api data frames
hadar_merge <- select(hadar_merge,"id.x", "fossil", "name", "uberon_id", "anatomical_region.y", "side", "dental", "completeness", "preserved_part") # select and reorder columns

# Convert character columns to factors. There are two ways.
hadar_merge[,'name']<-as.factor(hadar_merge[,'name'])
# or
hadar_merge$anatomical_region.y<-as.factor(hadar_merge$anatomical_region.y)
hadar_merge$side<-as.factor(hadar_merge$side)
```

The Hadar fossil data were merged with the Uberon skeletal element data based on the Uberon ID values to produce a dataframe with `r nrow(hadar_merge)` rows and `r ncol(hadar_merge)` columns. The columns include the following attributes: 

```{r}
data.frame(Variable=names(hadar_merge), Class = sapply(hadar_merge, typeof), Examples = sapply(hadar_merge, function(x) paste0(head(x), collapse = ", ")), row.names = NULL) %>% kable()
```


# Results
```{r}
# summarize counts of fossils and elements
ELEMENT_COUNT<-nrow(hadar_merge) # count how many rows in merged data frame
FOSSIL_COUNT<-length(levels(as.factor(hadar_merge$fossil))) # count how many unique values in fossil column
UNIQUE_ELEMENT_COUNT<-length(levels(as.factor(hadar_merge$uberon_id)))
```
The data set includes `r ELEMENT_COUNT` elements from `r FOSSIL_COUNT` fossil specimens. There are `r UNIQUE_ELEMENT_COUNT` unique skeletal elements. 

## Most Abundant Elements
The most 10 abundant elements are listed in Table 2. 
```{r table.cap='Table 1. Counts of the 10 most abundant elements'}
# Calculate number of unique skeletal element types and the abundance of the 10 most common elements.
element.summary<-summary(hadar_merge$name) # use summary function to generate counts of elements (factor)
element.summary.df<-data.frame("Element"=names(element.summary), "Count"=unname(element.summary), "Frequency"=(unname(element.summary)/sum(unname(element.summary)))) # convert summary to df
element.summary.df[1:10,] %>% kable() # convert df to pretty table
max.man<-c(element.summary["Mandible"], element.summary["Maxilla"])
btest.max.man<-binom.test(max.man, alternative=c("two.sided"))
```
Mandibles are the most abundant element in the Hadar assemblage. They are more than twice as abundant as maxillae (`r element.summary["Mandible"]` vs `r element.summary["Maxilla"] ` respectively) and this difference is significant (exact binomial test, Mandibles = `r max.man[1]`, N = `r sum(max.man)`, p = `r round(btest.max.man$p.value, digits=4)` **).

### Sides
Does the data indicate any difference in the preservation of left and right sided elements? The data frame includes a column to track element side. This is a factor with five levels: BOTH, L, MID, R, UNK (unknown). 
```{r table.cap='Table 2'}
side.table.full<-hadar_merge %>% count(side) # create summary df
side.table.lr<-side.table.full[side.table.full$side %in% c('L','R'),] # subset df to show just L/R rows
side.table.lr$proportions <- side.table.lr$n/sum(side.table.lr$n) # Add column with proportion data
btest.side<-binom.test(side.table.lr$n, alternative="two.sided") # binomial test for probability of 316 lefts out of a total of 604 trials with H0 that p = 0.5
knitr::kable(side.table.full, label=NA, caption='Table 1. Side counts')
```
The number of right and left elements is roughly the same, and not significantly different (exact binomial test, L = `r side.table.lr$n[1]`, N = `r sum(side.table.lr$n)`, p = `r round(btest.side$p.value, digits=4)`, NS)

## Element Representation by Anatomical Region

### Observed vs Expected Element Representation
How do the element counts at Hadar compared to the expected counts if there were to be full skeletal preservation?
```{r counts, fig.cap='Figure 1. Difference between exptected and observed frequencies of elements by region. Block dots indicate the expected proportion of elements based on a human skeleton and the orange dots indicate the observed frequency'}
# Bivariate Dotchart/Expected v. Observed
# Identify proportions & counts; cranial, dental, axial, appendicular
skeleton.proportions <- c(22/206, 32/206, 26/206, 126/206) 
expected_count <- c(77, 113, 91, 445) #expected regional counts, calculations in Google Drive/Sheets under "Analysis"
hadar_count <- c(114, 357, 68, 189) #observed hadar counts

#Bivariate Data
count_data <- data.frame(expected_count, hadar_count) #create data frame with both counts
regions <- c("cranial", "dental", "axial", "appendicular") #add a regions column
count_data <- cbind(count_data, regions) #combind the count & regions
count_data <- select(count_data,"regions", "expected_count", "hadar_count") #reorder
#count_data <- data.frame(t(count_data))

# Graph Dotchart
dotchart(count_data$hadar_count, labels = count_data$regions, bg = "darkorange",
         pt.cex = 1.5, xlim = range(count_data$expected_count, count_data$hadar_count) + c(-2, 2))
points(count_data$expected_count, 1:nrow(count_data), col = "black", pch = 19, cex = 1.5)
```

## Summaries of Expected and Observed Recorded Counts and Proportions

```{r}
# Regional expected 
regions_expected <- hadar_api%>%group_by(anatomical_region)%>%summarise(count=length(anatomical_region))

regions_expected <- data.frame(regions=regions_expected$anatomical_region, count = regions_expected$count, prop = regions_expected$count/sum(regions_expected$count))

regions_expected$exp_counts <- regions_expected$prop*809
knitr::kable(regions_expected, label=NA, caption='Table 3. Expected Regional Counts and Proportions') 

exp.counts <- data.frame(regions_expected$exp_counts) #create expected counts df

# Regional observed
regions_observed <- hadar_merge%>%group_by(anatomical_region.y)%>%summarise(count=length(anatomical_region.y))
regions_observed <- regions_observed[-6,]

regions_observed <- data.frame(regions=regions_observed$anatomical_region.y, count = regions_observed$count, prop = regions_observed$count/sum(regions_observed$count))

knitr::kable(regions_observed, label=NA, caption='Table 4. Observed Regional Counts and Proportions')

obs.counts <- data.frame(regions_observed$counts) #create expected counts
```

## Simuations 
```{r}
hadar_sim <- sample_n(hadar_api, 809,replace=TRUE)
sim.counts <- hadar_sim %>% group_by(anatomical_region) %>% summarise(count=length(anatomical_region)) #create simulated counts
#sim.counts <- sim.counts$count
knitr::kable(sim.counts, label=NA, caption='Table 5. Simulated Regional Counts')
#sim.counts <- sim.counts$count
#sim.counts[1:5]->sim.counts
```

### Calculate the Distance and Euclidean Value
```{r}
# Calculate Distance

dist(data.frame(sim.counts, exp.counts)) #-> distance
#euclidean <- function(a,b) sqrt(sum(a-b)^2)
#a = sim.counts
#b = exp.counts
#euclidean(a,b)
#euclidean(sim.counts, exp.counts)

#Doesn't knit properly!
```

Attempt at running simulation
```{r}
#NOTES: Iterate 3 times build up vector of those distance and make histogram plot dis between hadar ones out of all distance how great is my distance

# Multinomial Distribution; Sample from the multinomial 809 elements with replacement 1000 times
n <- 1000
m = 807
probs = c(.28,.09,.16,.45,.001) #props from regions_observed
simulation <-rmultinom(3, size = 807, prob = probs) 
  rownames(simulation) <- c("Appendicular", "Axial", "Cranial", "Dental", "Entire")
  colnames(simulation) <- c("Counts", "Counts", "Counts")
  head(simulation)
  
simulation.func <- function(m) {
  simulation <-rmultinom(3, size = m, prob = probs) 
  rownames(simulation) <- c("Appendicular", "Axial", "Cranial", "Dental", "Entire")
  colnames(simulation) <- c("Counts", "Counts", "Counts")
  head(simulation)
}

#apply () needs an X, MARGIN, and FUN
#apply(X=regions_observed, MARGIN = 2, FUN = simulation.func)
```

## Element Fragmentation Across Anatomical Region

### Completeness Counts
The data frame below includes a column to indicate the anatomical region and the number of elements within each region. 
```{r}
# Completeness Distribution [Use for completeness count]
completeness.table.full<-hadar_merge %>% count(completeness) # create summary df
knitr::kable(completeness.table.full, label=NA, caption='Table 2. Completeness Counts')
```

### Fragmentation Analysis by anatomical region

What is the percentage distribution of completeness by region? Is their evidence of preservation bias by anatomical region?
```{r, fragmentation, fig.cap='Figure 2. Completeness Distribution by Region. The green areas represent nearly complete elements, the orange is for elements that are fragmented, and the purple represents complete elements.'}
# Fragmentation distribution by anatomical region
hadar_chisq <- hadar_merge[,c("anatomical_region.y", "completeness")]
hadar_chisq_plot <- ggbarstats(data = hadar_chisq, x = completeness, y = anatomical_region.y) + labs(caption=NULL) #show the preservation stats for each anatomical region; 729 observations
hadar_chisq_plot 
```